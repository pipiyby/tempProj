"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.retrieveClientBalanceService=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _moment=_interopRequireDefault(require("moment"));var _helper=require("../utils/helper");var _index=require("../errors/index");var _index2=require("../token/index");var _index3=require("../database/index");var _index4=require("../database/queries/index");/**
 * Provides client balance
 * The endpoint provides details on the client balance for an individual account or a list of account ids
 * authorization String Authorization token that this system will verify.
 * accountNumber List PWM Account Number
 * correlationId String A tracking id provided by the calling application (optional)
 * returns clientBalanceResponse
 **/var retrieveClientBalanceService=/*#__PURE__*/function(){var _ref=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function _callee(authorization,accountNumber,transactionId,correlationId){var errorMsg,_errorMsg,token,validateTokenResponse,_errorMsg2,_errorMsg3,validationErrors,_errorMsg4,queryString,dbStartTime,queryResultSet,dbEndTime,_dbEndTime,_errorMsg5,returnData,response,resultArray,_errorMsg6;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(process.env.ENVIRONMENT.toLowerCase()!=="np2")){_context.next=21;break}if(!(0,_helper.empty)(authorization)){_context.next=6;break}errorMsg={code:40001,message:global.httpStatusCodes["401_MESSAGE"],fields:[{name:"authorization",value:"Token is empty"}]};throw new _index.AuthenticationError(global.httpStatusCodes.UNAUTHORIZED,global.httpStatusCodes["401_MESSAGE"],errorMsg);case 6:if(!(authorization&&authorization.indexOf("Bearer ")===-1)){_context.next=11;break}_errorMsg={code:40001,message:global.httpStatusCodes["401_MESSAGE"],fields:[{name:"authorization",value:"Token doesn't have a Bearer prefix to it"}]};throw new _index.AuthenticationError(global.httpStatusCodes.UNAUTHORIZED,global.httpStatusCodes["401_MESSAGE"],_errorMsg);case 11:token=authorization.substring(6).trim();_context.next=14;return(0,_index2.validateToken)(token);case 14:validateTokenResponse=_context.sent;if(!(validateTokenResponse.status==="EXPIRED")){_context.next=18;break}_errorMsg2={code:40002,message:global.httpStatusCodes["401_MESSAGE"],fields:[{name:"authorization",value:"Token is expired"}]};throw new _index.AuthenticationError(global.httpStatusCodes.UNAUTHORIZED,global.httpStatusCodes["401_MESSAGE"],_errorMsg2);case 18:if(!validateTokenResponse.error){_context.next=21;break}_errorMsg3={code:40003,message:global.httpStatusCodes["401_MESSAGE"],fields:[{name:"authorization",value:"Token is not valid"}]};throw new _index.AuthenticationError(global.httpStatusCodes.UNAUTHORIZED,global.httpStatusCodes["401_MESSAGE"],_errorMsg3);case 21:/**
	 * Business logic to validate Input variables
	 * accountId should be an array and cannot be empty
	 * startDate and endDate should be a number of format YYYYMMDD
	 */validationErrors=[];if((0,_helper.empty)(accountNumber)){validationErrors.push({name:"accountId",value:"accountId provided is empty"})}else if(accountNumber.constructor===Array){accountNumber=accountNumber.map(function(val){var temp=(""+val).trim();if(temp.constructor!==String){validationErrors.push({name:"accountNumber",value:"".concat(temp," should be of type string")})}else if(!(0,_helper.isAccountNumber)(temp)){validationErrors.push({name:"accountNumber",value:"".concat(temp," is not a valid accountNumber")})}return temp})}if((0,_helper.empty)(validationErrors)){_context.next=26;break}_errorMsg4={code:40301,message:"Some parameters are missing",fields:validationErrors};throw new _index.ValidationError(global.httpStatusCodes.BAD_REQUEST,"Some parameters are missing",_errorMsg4);case 26:/**
	 * All the inputs are valid.
	 * Query the view and return the data
	 */ /**
	 * Quick hack to execute the query in varchar instead of nvarchar,.
	 * Sequelize inbuilt query builder converts string to unicode, which has a performance impact on the view
	 * This performance is caused because of nvarchar usage by sequelize instead of varchar
	 * Workaround is to manually replace the query.
	 * Note: use singlequote while inserting parameters because doublequote will throw error in mssql.
	 */queryString=_index4.queryForClientBalance.replace(":accountId",accountNumber.map(function(account){return"ca.CustodianAccountID='".concat(account.trim(),"'")}).join(" OR "));dbStartTime=Date.now();_context.prev=28;_context.next=31;return _index3.databaseConnection.sequelize.query(queryString,{type:_index3.databaseConnection.sequelize.QueryTypes.RAW,raw:true});case 31:queryResultSet=_context.sent;dbEndTime=Date.now()-dbStartTime+"ms";global.logger.info("Data Access success",{dbElapsedTime:dbEndTime,operationName:"dbQuery",transactionId:transactionId,correlationId:correlationId});_context.next=42;break;case 36:_context.prev=36;_context.t0=_context["catch"](28);_dbEndTime=Date.now()-dbStartTime+"ms";global.logger.info("Data Access Failed",{dbElapsedTime:_dbEndTime,operationName:"dbQuery",transactionId:transactionId,correlationId:correlationId,stackTrace:_context.t0.stack});_errorMsg5={code:60001,message:"Database Error",fields:[]};throw new _index.DataAccessError(global.httpStatusCodes.INTERNAL_SERVER_ERROR,"Database error",_errorMsg5);case 42:returnData={};returnData.clientBalance={};response=[];resultArray=queryResultSet[0];if((0,_helper.empty)(resultArray)){_context.next=52;break}// This means we have data returned from the DB. Time to format it.
resultArray.map(function(value){response.push({"accountNumber":value.accountNumber?value.accountNumber:null,"balance":!(0,_helper.empty)(value.currentBalance)?value.currentBalance:0,"asOfDate":value.asOfDate?(0,_moment["default"])(value.asOfDate.toString()).format("YYYY-MM-DD"):null,"pendingDividend":value.pendingDividend?value.pendingDividend:null,//to be updated in future
"marginBalance":value.marginBalance?value.marginBalance:null,//to be updated in future
"dayChangeAmt":value.dayChangeAmt?value.dayChangeAmt:null,//to be updated in future
"dayChangePct":value.dayChangePct?value.dayChangePct:null,//to be updated in future
"accruedInterest":value.accruedInterest?value.accruedInterest:null//to be updated in future
})});returnData.clientBalance.records=response;return _context.abrupt("return",returnData);case 52:if(!(resultArray&&resultArray.length===0)){_context.next=55;break}_errorMsg6={code:60002,message:"No content found in database",fields:[]};throw new _index.NoContentError(global.httpStatusCodes.NO_CONTENT,global.httpStatusCodes["204_MESSAGE"],_errorMsg6);case 55:case"end":return _context.stop();}}},_callee,null,[[28,36]])}));return function retrieveClientBalanceService(_x,_x2,_x3,_x4){return _ref.apply(this,arguments)}}();exports.retrieveClientBalanceService=retrieveClientBalanceService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlL0NsaWVudEJhbGFuY2VTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbInJldHJpZXZlQ2xpZW50QmFsYW5jZVNlcnZpY2UiLCJhdXRob3JpemF0aW9uIiwiYWNjb3VudE51bWJlciIsInRyYW5zYWN0aW9uSWQiLCJjb3JyZWxhdGlvbklkIiwicHJvY2VzcyIsImVudiIsIkVOVklST05NRU5UIiwidG9Mb3dlckNhc2UiLCJlcnJvck1zZyIsImNvZGUiLCJtZXNzYWdlIiwiZ2xvYmFsIiwiaHR0cFN0YXR1c0NvZGVzIiwiZmllbGRzIiwibmFtZSIsInZhbHVlIiwiQXV0aGVudGljYXRpb25FcnJvciIsIlVOQVVUSE9SSVpFRCIsImluZGV4T2YiLCJ0b2tlbiIsInN1YnN0cmluZyIsInRyaW0iLCJ2YWxpZGF0ZVRva2VuUmVzcG9uc2UiLCJzdGF0dXMiLCJlcnJvciIsInZhbGlkYXRpb25FcnJvcnMiLCJwdXNoIiwiY29uc3RydWN0b3IiLCJBcnJheSIsIm1hcCIsInZhbCIsInRlbXAiLCJTdHJpbmciLCJWYWxpZGF0aW9uRXJyb3IiLCJCQURfUkVRVUVTVCIsInF1ZXJ5U3RyaW5nIiwicXVlcnlGb3JDbGllbnRCYWxhbmNlIiwicmVwbGFjZSIsImFjY291bnQiLCJqb2luIiwiZGJTdGFydFRpbWUiLCJEYXRlIiwibm93IiwiZGF0YWJhc2VDb25uZWN0aW9uIiwic2VxdWVsaXplIiwicXVlcnkiLCJ0eXBlIiwiUXVlcnlUeXBlcyIsIlJBVyIsInJhdyIsInF1ZXJ5UmVzdWx0U2V0IiwiZGJFbmRUaW1lIiwibG9nZ2VyIiwiaW5mbyIsImRiRWxhcHNlZFRpbWUiLCJvcGVyYXRpb25OYW1lIiwic3RhY2tUcmFjZSIsInN0YWNrIiwiRGF0YUFjY2Vzc0Vycm9yIiwiSU5URVJOQUxfU0VSVkVSX0VSUk9SIiwicmV0dXJuRGF0YSIsImNsaWVudEJhbGFuY2UiLCJyZXNwb25zZSIsInJlc3VsdEFycmF5IiwiY3VycmVudEJhbGFuY2UiLCJhc09mRGF0ZSIsInRvU3RyaW5nIiwiZm9ybWF0IiwicGVuZGluZ0RpdmlkZW5kIiwibWFyZ2luQmFsYW5jZSIsImRheUNoYW5nZUFtdCIsImRheUNoYW5nZVBjdCIsImFjY3J1ZWRJbnRlcmVzdCIsInJlY29yZHMiLCJsZW5ndGgiLCJOb0NvbnRlbnRFcnJvciIsIk5PX0NPTlRFTlQiXSwibWFwcGluZ3MiOiJBQUFBLGEseVdBQ0Esc0RBQ0EsdUNBQ0Esc0NBR0Esc0NBQ0EseUNBQ0EsaURBR0E7Ozs7Ozs7SUFRQSxHQUFNQSxDQUFBQSw0QkFBNEIsOEdBQUcsaUJBQU9DLGFBQVAsQ0FBc0JDLGFBQXRCLENBQXFDQyxhQUFyQyxDQUFvREMsYUFBcEQsa1ZBQ2hDQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsV0FBWixDQUF3QkMsV0FBeEIsS0FBMEMsS0FEViw4QkFFL0Isa0JBQU1QLGFBQU4sQ0FGK0Isd0JBRzlCUSxRQUg4QixDQUduQixDQUNkQyxJQUFJLENBQUUsS0FEUSxDQUVkQyxPQUFPLENBQUVDLE1BQU0sQ0FBQ0MsZUFBUCxDQUF1QixhQUF2QixDQUZLLENBR2RDLE1BQU0sQ0FBRSxDQUFDLENBQ1JDLElBQUksQ0FBRSxlQURFLENBRVJDLEtBQUssQ0FBRSxnQkFGQyxDQUFELENBSE0sQ0FIbUIsTUFXNUIsSUFBSUMsMkJBQUosQ0FBd0JMLE1BQU0sQ0FBQ0MsZUFBUCxDQUF1QkssWUFBL0MsQ0FBNkROLE1BQU0sQ0FBQ0MsZUFBUCxDQUF1QixhQUF2QixDQUE3RCxDQUFvR0osUUFBcEcsQ0FYNEIsYUFZeEJSLGFBQWEsRUFBSUEsYUFBYSxDQUFDa0IsT0FBZCxDQUFzQixTQUF0QixJQUFxQyxDQUFDLENBWi9CLDBCQWE5QlYsU0FiOEIsQ0FhbkIsQ0FDZEMsSUFBSSxDQUFFLEtBRFEsQ0FFZEMsT0FBTyxDQUFFQyxNQUFNLENBQUNDLGVBQVAsQ0FBdUIsYUFBdkIsQ0FGSyxDQUdkQyxNQUFNLENBQUUsQ0FBQyxDQUNSQyxJQUFJLENBQUUsZUFERSxDQUVSQyxLQUFLLENBQUUsMENBRkMsQ0FBRCxD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S0FBSyxDQUFDd0QsWUFBM0IsQ0FBMEMsSUFQN0MsQ0FPbUQ7QUFDaEUsa0JBQW1CeEQsS0FBSyxDQUFDeUQsZUFBTixDQUF3QnpELEtBQUssQ0FBQ3lELGVBQTlCLENBQWdELElBQUs7QUFSM0QsQ0FBZCxDQVVBLENBWEQsRUFZQVosVUFBVSxDQUFDQyxhQUFYLENBQXlCWSxPQUF6QixDQUFtQ1gsUUFBbkMsQ0F0Sm1DLGdDQXdKNUJGLFVBeEo0QixlQTBKekJHLFdBQVcsRUFBSUEsV0FBVyxDQUFDVyxNQUFaLEdBQXVCLENBMUpiLDBCQTJKL0JsRSxVQTNKK0IsQ0EySnBCLENBQ2RDLElBQUksQ0FBRSxLQURRLENBRWRDLE9BQU8sQ0FBRSw4QkFGSyxDQUdkRyxNQUFNLENBQUUsRUFITSxDQTNKb0IsTUFnSzdCLElBQUk4RCxzQkFBSixDQUFtQmhFLE1BQU0sQ0FBQ0MsZUFBUCxDQUF1QmdFLFVBQTFDLENBQXNEakUsTUFBTSxDQUFDQyxlQUFQLENBQXVCLGFBQXZCLENBQXRELENBQTZGSixVQUE3RixDQWhLNkIsc0VBQUgsa0JBQTVCVCxDQUFBQSw0QkFBNEIsc0RBQWxDLEMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuaW1wb3J0IG1vbWVudCBmcm9tIFwibW9tZW50XCI7XHJcbmltcG9ydCB7ZW1wdHksIGlzQWNjb3VudE51bWJlcn0gZnJvbSBcIi4uL3V0aWxzL2hlbHBlclwiO1xyXG5pbXBvcnQge1xyXG5cdEF1dGhlbnRpY2F0aW9uRXJyb3IsIERhdGFBY2Nlc3NFcnJvciwgTm9Db250ZW50RXJyb3IsIFZhbGlkYXRpb25FcnJvclxyXG59IGZyb20gXCIuLi9lcnJvcnMvaW5kZXhcIjtcclxuaW1wb3J0IHt2YWxpZGF0ZVRva2VufSBmcm9tIFwiLi4vdG9rZW4vaW5kZXhcIjtcclxuaW1wb3J0IHtkYXRhYmFzZUNvbm5lY3Rpb259IGZyb20gXCIuLi9kYXRhYmFzZS9pbmRleFwiO1xyXG5pbXBvcnQge3F1ZXJ5Rm9yQ2xpZW50QmFsYW5jZX0gZnJvbSBcIi4uL2RhdGFiYXNlL3F1ZXJpZXMvaW5kZXhcIjtcclxuXHJcblxyXG4vKipcclxuICogUHJvdmlkZXMgY2xpZW50IGJhbGFuY2VcclxuICogVGhlIGVuZHBvaW50IHByb3ZpZGVzIGRldGFpbHMgb24gdGhlIGNsaWVudCBiYWxhbmNlIGZvciBhbiBpbmRpdmlkdWFsIGFjY291bnQgb3IgYSBsaXN0IG9mIGFjY291bnQgaWRzXHJcbiAqIGF1dGhvcml6YXRpb24gU3RyaW5nIEF1dGhvcml6YXRpb24gdG9rZW4gdGhhdCB0aGlzIHN5c3RlbSB3aWxsIHZlcmlmeS5cclxuICogYWNjb3VudE51bWJlciBMaXN0IFBXTSBBY2NvdW50IE51bWJlclxyXG4gKiBjb3JyZWxhdGlvbklkIFN0cmluZyBBIHRyYWNraW5nIGlkIHByb3ZpZGVkIGJ5IHRoZSBjYWxsaW5nIGFwcGxpY2F0aW9uIChvcHRpb25hbClcclxuICogcmV0dXJucyBjbGllbnRCYWxhbmNlUmVzcG9uc2VcclxuICoqL1xyXG5jb25zdCByZXRyaWV2ZUNsaWVudEJhbGFuY2VTZXJ2aWNlID0gYXN5bmMgKGF1dGhvcml6YXRpb24sIGFjY291bnROdW1iZXIsIHRyYW5zYWN0aW9uSWQsIGNvcnJlbGF0aW9uSWQpID0+IHsgLy9lc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzXHJcblx0aWYgKHByb2Nlc3MuZW52LkVOVklST05NRU5ULnRvTG93ZXJDYXNlKCkgIT09IFwibnAyXCIpIHtcclxuXHRcdGlmIChlbXB0eShhdXRob3JpemF0aW9uKSkge1xyXG5cdFx0XHRsZXQgZXJyb3JNc2cgPSB7XHJcblx0XHRcdFx0Y29kZTogNDAwMDEsXHJcblx0XHRcdFx0bWVzc2FnZTogZ2xvYmFsLmh0dHBTdGF0dXNDb2Rlc1tcIjQwMV9NRVNTQUdFXCJdLFxyXG5cdFx0XHRcdGZpZWxkczogW3tcclxuXHRcdFx0XHRcdG5hbWU6IFwiYXV0aG9yaXphdGlvblwiLFxyXG5cdFx0XHRcdFx0dmFsdWU6IFwiVG9rZW4gaXMgZW1wdHlcIlxyXG5cdFx0XHRcdH1dXHJcblx0XHRcdH07XHJcblx0XHRcdHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKGdsb2JhbC5odHRwU3RhdHVzQ29kZXMuVU5BVVRIT1JJWkVELCBnbG9iYWwuaHR0cFN0YXR1c0NvZGVzW1wiNDAxX01FU1NBR0VcIl0sIGVycm9yTXNnKTtcclxuXHRcdH0gZWxzZSBpZiAoYXV0aG9yaXphdGlvbiAmJiBhdXRob3JpemF0aW9uLmluZGV4T2YoXCJCZWFyZXIgXCIpID09PSAtMSkge1xyXG5cdFx0XHRsZXQgZXJyb3JNc2cgPSB7XHJcblx0XHRcdFx0Y29kZTogNDAwMDEsXHJcblx0XHRcdFx0bWVzc2FnZTogZ2xvYmFsLmh0dHBTdGF0dXNDb2Rlc1tcIjQwMV9NRVNTQUdFXCJdLFxyXG5cdFx0XHRcdGZpZWxkczogW3tcclxuXHRcdFx0XHRcdG5hbWU6IFwiYXV0aG9yaXphdGlvblwiLFxyXG5cdFx0XHRcdFx0dmFsdWU6IFwiVG9rZW4gZG9lc24ndCBoYXZlIGEgQmVhcmVyIHByZWZpeCB0byBpdFwiXHJcblx0XHRcdFx0fV1cclxuXHRcdFx0fTtcclxuXHRcdFx0dGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IoZ2xvYmFsLmh0dHBTdGF0dXNDb2Rlcy5VTkFVVEhPUklaRUQsIGdsb2JhbC5odHRwU3RhdHVzQ29kZXNbXCI0MDFfTUVTU0FHRVwiXSwgZXJyb3JNc2cpO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0Y29uc3QgdG9rZW4gPSBhdXRob3JpemF0aW9uLnN1YnN0cmluZyg2KS50cmltKCk7XHJcblx0XHRcdGxldCB2YWxpZGF0ZVRva2VuUmVzcG9uc2UgPSBhd2FpdCB2YWxpZGF0ZVRva2VuKHRva2VuKTtcclxuXHJcblx0XHRcdGlmICh2YWxpZGF0ZVRva2VuUmVzcG9uc2Uuc3RhdHVzID09PSBcIkVYUElSRURcIikge1xyXG5cdFx0XHRcdGxldCBlcnJvck1zZyA9IHtcclxuXHRcdFx0XHRcdGNvZGU6IDQwMDAyLFxyXG5cdFx0XHRcdFx0bWVzc2FnZTogZ2xvYmFsLmh0dHBTdGF0dXNDb2Rlc1tcIjQwMV9NRVNTQUdFXCJdLFxyXG5cdFx0XHRcdFx0ZmllbGRzOiBbe1xyXG5cdFx0XHRcdFx0XHRuYW1lOiBcImF1dGhvcml6YXRpb25cIixcclxuXHRcdFx0XHRcdFx0dmFsdWU6IFwiVG9rZW4gaXMgZXhwaXJlZFwiXHJcblx0XHRcdFx0XHR9XVxyXG5cdFx0XHRcdH07XHJcblxyXG5cdFx0XHRcdHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKGdsb2JhbC5odHRwU3RhdHVzQ29kZXMuVU5BVVRIT1JJWkVELCBnbG9iYWwuaHR0cFN0YXR1c0NvZGVzW1wiNDAxX01FU1NBR0VcIl0sIGVycm9yTXNnKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gSWYgZXJyb3IgaXMgdW5kZWZpbmVkLCB0aGVuIHRoZSBwcm92aWRlZCB0b2tlbiBpcyB2YWxpZFxyXG5cdFx0XHRpZiAodmFsaWRhdGVUb2tlblJlc3BvbnNlLmVycm9yKSB7XHJcblx0XHRcdFx0bGV0IGVycm9yTXNnID0ge1xyXG5cdFx0XHRcdFx0Y29kZTogNDAwMDMsXHJcblx0XHRcdFx0XHRtZXNzYWdlOiBnbG9iYWwuaHR0cFN0YXR1c0NvZGVzW1wiNDAxX01FU1NBR0VcIl0sXHJcblx0XHRcdFx0XHRmaWVsZHM6IFt7XHJcblx0XHRcdFx0XHRcdG5hbWU6IFwiYXV0aG9yaXphdGlvblwiLFxyXG5cdFx0XHRcdFx0XHR2YWx1ZTogXCJUb2tlbiBpcyBub3QgdmFsaWRcIlxyXG5cdFx0XHRcdFx0fV1cclxuXHRcdFx0XHR9O1xyXG5cdFx0XHRcdHRocm93IG5ldyBBdXRoZW50aWNhdGlvbkVycm9yKGdsb2JhbC5odHRwU3RhdHVzQ29kZXMuVU5BVVRIT1JJWkVELCBnbG9iYWwuaHR0cFN0YXR1c0NvZGVzW1wiNDAxX01FU1NBR0VcIl0sIGVycm9yTXNnKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1cclxuXHQvKipcclxuXHQgKiBCdXNpbmVzcyBsb2dpYyB0byB2YWxpZGF0ZSBJbnB1dCB2YXJpYWJsZXNcclxuXHQgKiBhY2NvdW50SWQgc2hvdWxkIGJlIGFuIGFycmF5IGFuZCBjYW5ub3QgYmUgZW1wdHlcclxuXHQgKiBzdGFydERhdGUgYW5kIGVuZERhdGUgc2hvdWxkIGJlIGEgbnVtYmVyIG9mIGZvcm1hdCBZWVlZTU1ERFxyXG5cdCAqL1xyXG5cdGxldCB2YWxpZGF0aW9uRXJyb3JzID0gW107XHJcblxyXG5cdGlmIChlbXB0eShhY2NvdW50TnVtYmVyKSkge1xyXG5cdFx0dmFsaWRhdGlvbkVycm9ycy5wdXNoKHtuYW1lOiBcImFjY291bnRJZFwiLCB2YWx1ZTogXCJhY2NvdW50SWQgcHJvdmlkZWQgaXMgZW1wdHlcIn0pO1xyXG5cdH0gZWxzZSBpZiAoYWNjb3VudE51bWJlci5jb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHtcclxuXHRcdGFjY291bnROdW1iZXIgPSBhY2NvdW50TnVtYmVyLm1hcCgodmFsKSA9PiB7XHJcblx0XHRcdGxldCB0ZW1wID0gKFwiXCIgKyB2YWwpLnRyaW0oKTtcclxuXHRcdFx0aWYgKHRlbXAuY29uc3RydWN0b3IgIT09IFN0cmluZykge1xyXG5cdFx0XHRcdHZhbGlkYXRpb25FcnJvcnMucHVzaCh7bmFtZTogXCJhY2NvdW50TnVtYmVyXCIsIHZhbHVlOiBgJHt0ZW1wfSBzaG91bGQgYmUgb2YgdHlwZSBzdHJpbmdgfSk7XHJcblx0XHRcdH0gZWxzZSBpZiAoIWlzQWNjb3VudE51bWJlcih0ZW1wKSkge1xyXG5cdFx0XHRcdHZhbGlkYXRpb25FcnJvcnMucHVzaCh7bmFtZTogXCJhY2NvdW50TnVtYmVyXCIsIHZhbHVlOiBgJHt0ZW1wfSBpcyBub3QgYSB2YWxpZCBhY2NvdW50TnVtYmVyYH0pO1xyXG5cdFx0XHR9XHJcblx0XHRcdHJldHVybiB0ZW1wO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRpZiAoIWVtcHR5KHZhbGlkYXRpb25FcnJvcnMpKSB7XHJcblx0XHRsZXQgZXJyb3JNc2cgPSB7XHJcblx0XHRcdGNvZGU6IDQwMzAxLFxyXG5cdFx0XHRtZXNzYWdlOiBcIlNvbWUgcGFyYW1ldGVycyBhcmUgbWlzc2luZ1wiLFxyXG5cdFx0XHRmaWVsZHM6IHZhbGlkYXRpb25FcnJvcnNcclxuXHRcdH07XHJcblx0XHR0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGdsb2JhbC5odHRwU3RhdHVzQ29kZXMuQkFEX1JFUVVFU1QsIFwiU29tZSBwYXJhbWV0ZXJzIGFyZSBtaXNzaW5nXCIsIGVycm9yTXNnKTtcclxuXHR9XHJcblxyXG5cclxuXHQvKipcclxuXHQgKiBBbGwgdGhlIGlucHV0cyBhcmUgdmFsaWQuXHJcblx0ICogUXVlcnkgdGhlIHZpZXcgYW5kIHJldHVybiB0aGUgZGF0YVxyXG5cdCAqL1xyXG5cclxuXHQvKipcclxuXHQgKiBRdWljayBoYWNrIHRvIGV4ZWN1dGUgdGhlIHF1ZXJ5IGluIHZhcmNoYXIgaW5zdGVhZCBvZiBudmFyY2hhciwuXHJcblx0ICogU2VxdWVsaXplIGluYnVpbHQgcXVlcnkgYnVpbGRlciBjb252ZXJ0cyBzdHJpbmcgdG8gdW5pY29kZSwgd2hpY2ggaGFzIGEgcGVyZm9ybWFuY2UgaW1wYWN0IG9uIHRoZSB2aWV3XHJcblx0ICogVGhpcyBwZXJmb3JtYW5jZSBpcyBjYXVzZWQgYmVjYXVzZSBvZiBudmFyY2hhciB1c2FnZSBieSBzZXF1ZWxpemUgaW5zdGVhZCBvZiB2YXJjaGFyXHJcblx0ICogV29ya2Fyb3VuZCBpcyB0byBtYW51YWxseSByZXBsYWNlIHRoZSBxdWVyeS5cclxuXHQgKiBOb3RlOiB1c2Ugc2luZ2xlcXVvdGUgd2hpbGUgaW5zZXJ0aW5nIHBhcmFtZXRlcnMgYmVjYXVzZSBkb3VibGVxdW90ZSB3aWxsIHRocm93IGVycm9yIGluIG1zc3FsLlxyXG5cdCAqL1xyXG5cdGxldCBxdWVyeVN0cmluZyA9IHF1ZXJ5Rm9yQ2xpZW50QmFsYW5jZS5yZXBsYWNlKFwiOmFjY291bnRJZFwiLCBhY2NvdW50TnVtYmVyLm1hcChhY2NvdW50ID0+IGBjYS5DdXN0b2RpYW5BY2NvdW50SUQ9JyR7YWNjb3VudC50cmltKCl9J2ApLmpvaW4oXCIgT1IgXCIpKTtcclxuXHJcblx0bGV0IGRiU3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuXHRsZXQgcXVlcnlSZXN1bHRTZXQ7XHJcblx0dHJ5IHtcclxuXHJcblx0XHRxdWVyeVJlc3VsdFNldCA9IGF3YWl0IGRhdGFiYXNlQ29ubmVjdGlvbi5zZXF1ZWxpemUucXVlcnkocXVlcnlTdHJpbmcsIHtcclxuXHRcdFx0dHlwZTogZGF0YWJhc2VDb25uZWN0aW9uLnNlcXVlbGl6ZS5RdWVyeVR5cGVzLlJBVywgcmF3OiB0cnVlXHJcblx0XHR9KTtcclxuXHJcblx0XHRsZXQgZGJFbmRUaW1lID0gKERhdGUubm93KCkgLSBkYlN0YXJ0VGltZSkgKyBcIm1zXCI7XHJcblx0XHRnbG9iYWwubG9nZ2VyLmluZm8oXCJEYXRhIEFjY2VzcyBzdWNjZXNzXCIsIHtcclxuXHRcdFx0ZGJFbGFwc2VkVGltZTogZGJFbmRUaW1lLFxyXG5cdFx0XHRvcGVyYXRpb25OYW1lOiBcImRiUXVlcnlcIixcclxuXHRcdFx0dHJhbnNhY3Rpb25JZCxcclxuXHRcdFx0Y29ycmVsYXRpb25JZFxyXG5cdFx0fSk7XHJcblxyXG5cdH0gY2F0Y2ggKGUpIHtcclxuXHRcdGxldCBkYkVuZFRpbWUgPSAoRGF0ZS5ub3coKSAtIGRiU3RhcnRUaW1lKSArIFwibXNcIjtcclxuXHRcdGdsb2JhbC5sb2dnZXIuaW5mbyhcIkRhdGEgQWNjZXNzIEZhaWxlZFwiLCB7XHJcblx0XHRcdGRiRWxhcHNlZFRpbWU6IGRiRW5kVGltZSxcclxuXHRcdFx0b3BlcmF0aW9uTmFtZTogXCJkYlF1ZXJ5XCIsXHJcblx0XHRcdHRyYW5zYWN0aW9uSWQsXHJcblx0XHRcdGNvcnJlbGF0aW9uSWQsXHJcblx0XHRcdHN0YWNrVHJhY2U6IGUuc3RhY2tcclxuXHRcdH0pO1xyXG5cdFx0bGV0IGVycm9yTXNnID0ge1xyXG5cdFx0XHRjb2RlOiA2MDAwMSxcclxuXHRcdFx0bWVzc2FnZTogXCJEYXRhYmFzZSBFcnJvclwiLFxyXG5cdFx0XHRmaWVsZHM6IFtdXHJcblx0XHR9O1xyXG5cdFx0dGhyb3cgbmV3IERhdGFBY2Nlc3NFcnJvcihnbG9iYWwuaHR0cFN0YXR1c0NvZGVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUiwgXCJEYXRhYmFzZSBlcnJvclwiLCBlcnJvck1zZyk7XHJcblx0fVxyXG5cclxuXHRsZXQgcmV0dXJuRGF0YSA9IHt9O1xyXG5cdHJldHVybkRhdGEuY2xpZW50QmFsYW5jZSA9IHt9O1xyXG5cdGxldCByZXNwb25zZSA9IFtdO1xyXG5cdGNvbnN0IHJlc3VsdEFycmF5ID0gcXVlcnlSZXN1bHRTZXRbMF07XHJcblx0aWYgKCFlbXB0eShyZXN1bHRBcnJheSkpIHtcclxuXHRcdC8vIFRoaXMgbWVhbnMgd2UgaGF2ZSBkYXRhIHJldHVybmVkIGZyb20gdGhlIERCLiBUaW1lIHRvIGZvcm1hdCBpdC5cclxuXHJcblx0XHRyZXN1bHRBcnJheS5tYXAoKHZhbHVlKSA9PiB7XHJcblx0XHRcdHJlc3BvbnNlLnB1c2goe1xyXG5cdFx0XHRcdFwiYWNjb3VudE51bWJlclwiOiB2YWx1ZS5hY2NvdW50TnVtYmVyID8gdmFsdWUuYWNjb3VudE51bWJlciA6IG51bGwsXHJcblx0XHRcdFx0XCJiYWxhbmNlXCI6ICFlbXB0eSh2YWx1ZS5jdXJyZW50QmFsYW5jZSkgPyB2YWx1ZS5jdXJyZW50QmFsYW5jZSA6IDAsXHJcblx0XHRcdFx0XCJhc09mRGF0ZVwiOiB2YWx1ZS5hc09mRGF0ZSA/IG1vbWVudCh2YWx1ZS5hc09mRGF0ZS50b1N0cmluZygpKS5mb3JtYXQoXCJZWVlZLU1NLUREXCIpIDogbnVsbCxcclxuXHRcdFx0XHRcInBlbmRpbmdEaXZpZGVuZFwiOiB2YWx1ZS5wZW5kaW5nRGl2aWRlbmQgPyB2YWx1ZS5wZW5kaW5nRGl2aWRlbmQgOiBudWxsLC8vdG8gYmUgdXBkYXRlZCBpbiBmdXR1cmVcclxuXHRcdFx0XHRcIm1hcmdpbkJhbGFuY2VcIjogdmFsdWUubWFyZ2luQmFsYW5jZSA/IHZhbHVlLm1hcmdpbkJhbGFuY2UgOiBudWxsLC8vdG8gYmUgdXBkYXRlZCBpbiBmdXR1cmVcclxuXHRcdFx0XHRcImRheUNoYW5nZUFtdFwiOiB2YWx1ZS5kYXlDaGFuZ2VBbXQgPyB2YWx1ZS5kYXlDaGFuZ2VBbXQgOiBudWxsLC8vdG8gYmUgdXBkYXRlZCBpbiBmdXR1cmVcclxuXHRcdFx0XHRcImRheUNoYW5nZVBjdFwiOiB2YWx1ZS5kYXlDaGFuZ2VQY3QgPyB2YWx1ZS5kYXlDaGFuZ2VQY3QgOiBudWxsLCAvL3RvIGJlIHVwZGF0ZWQgaW4gZnV0dXJlXHJcblx0XHRcdFx0XCJhY2NydWVkSW50ZXJlc3RcIjogdmFsdWUuYWNjcnVlZEludGVyZXN0ID8gdmFsdWUuYWNjcnVlZEludGVyZXN0IDogbnVsbCAvL3RvIGJlIHVwZGF0ZWQgaW4gZnV0dXJlXHJcblx0XHRcdH0pO1xyXG5cdFx0fSk7XHJcblx0XHRyZXR1cm5EYXRhLmNsaWVudEJhbGFuY2UucmVjb3JkcyA9IHJlc3BvbnNlO1xyXG5cclxuXHRcdHJldHVybiByZXR1cm5EYXRhO1xyXG5cclxuXHR9IGVsc2UgaWYgKHJlc3VsdEFycmF5ICYmIHJlc3VsdEFycmF5Lmxlbmd0aCA9PT0gMCkge1xyXG5cdFx0bGV0IGVycm9yTXNnID0ge1xyXG5cdFx0XHRjb2RlOiA2MDAwMixcclxuXHRcdFx0bWVzc2FnZTogXCJObyBjb250ZW50IGZvdW5kIGluIGRhdGFiYXNlXCIsXHJcblx0XHRcdGZpZWxkczogW11cclxuXHRcdH07XHJcblx0XHR0aHJvdyBuZXcgTm9Db250ZW50RXJyb3IoZ2xvYmFsLmh0dHBTdGF0dXNDb2Rlcy5OT19DT05URU5ULCBnbG9iYWwuaHR0cFN0YXR1c0NvZGVzW1wiMjA0X01FU1NBR0VcIl0sIGVycm9yTXNnKTtcclxuXHR9XHJcblxyXG59O1xyXG5cclxuZXhwb3J0IHtyZXRyaWV2ZUNsaWVudEJhbGFuY2VTZXJ2aWNlfTtcclxuIl19